twd97lat = spatial_grid$twd97lat,
time = time_grid,
PM10 = NA  # 初始化要預測的網格
)
# 5. 創建 SpatialPoints 和 STFDF 對象
spatial_points <- SpatialPoints(space_grid, proj4string = CRS("+init=epsg:3826"))
grid_ST <- STFDF(
sp = spatial_points,
time = time_range,
data = data.frame(PM10 = rep(NA, length(time_range) * nrow(space_grid)))  # 修正行數
)
pr <- krigeST(PM10~1, data=STFDF_daily, modelList=prodSumModel_Vgm, newdata=grid_ST)
pr
stplot(pr)
predicted_values <- as.data.frame(pr)
slice_27 <- predicted_values%>%filter(time=='2024-02-27')
taiwan_map <- map("worldHires", "Taiwan", plot = FALSE, fill = TRUE)
world_clean <- world[!is.na(world$NAME), ]  # 去除 NAME 為 NA 的行
taiwan_map <- world_clean[world_clean$NAME == "Taiwan", ]
taiwan_map_sf <- st_as_sf(taiwan_map)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
# 限制繪圖範圍 (根據台灣主島範圍)
coord_sf(xlim = c(119000, 123000), ylim = c(2600000, 2750000)) +
theme_minimal()
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)
)
stplot(pr)
pr
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid")
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c()
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
# 限制繪圖範圍 (根據台灣主島範圍)
coord_sf(xlim = c(119000, 123000)) +
theme_minimal()
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
# 限制繪圖範圍 (根據台灣主島範圍)
coord_sf(xlim = c(123000, 119000)) +
theme_minimal()
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
# 限制繪圖範圍 (根據台灣主島範圍)
coord_sf(xlim = c(118000, 123000)) +
theme_minimal()
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
)
slice_27
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_cartesian(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +  scale_x_continuous(limits = range(slice_27$twd97lon)) +
scale_y_continuous(limits = range(slice_27$twd97lat)) +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_cartesian(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_cartesian(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)+
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = monitoring_stations, aes(x = twd97lon, y = twd97lat),
color = "red", size = 3, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = monitoring_stations, aes(x = twd97lon, y = twd97lat, label = station_id),
color = "blue", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
pivot_data
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "red", size = 3, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = monitoring_stations, aes(x = twd97lon, y = twd97lat, label = station_id),
color = "blue", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "red", size = 3, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station_id),
color = "blue", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "red", size = 3, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
color = "blue", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "red", size = 2, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
color = "blue", size = 1, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "red", size = 2, shape = 21, fill = "red") +
# 添加監測站名稱標籤
geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
color = "blue", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "#74dff2", size = 2, shape = 21, fill = "#74dff2") +
# 添加監測站名稱標籤
geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
color = "#95edd7", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "#74dff2", size = 2, shape = 21, fill = "#74dff2") +
# 添加監測站名稱標籤
# geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
#           color = "#95edd7", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
var
View(var)
var <- variogram(PM10~1, STFDF_daily[!is.na(STFDF_daily[,"2024-01-01::2024-06-30","PM10"]$PM10),
"2024-01-01::2024-06-","PM10"], width=width, cutoff=cutoff, tlags=0:10)
var
?variogram
var <- variogram(PM10~1, STFDF_daily[!is.na(STFDF_daily[,"2024-01-01::2024-06-30","PM10"]$PM10),
"2024-01-01::2024-06-","PM10"], width=width, cutoff=cutoff)
plot(var)            # sample variograms at each time lag
plot(var, map=FALSE)      # ST-variogram map
plot(var, wireframe=TRUE) # ST-variogram wireframe
# 模型設定，vgm內分別是sill, range, nugget, k是乘積係數，控制兩者之間的交互強度
prodSumModel <- vgmST("productSum", space = vgm(1, "Exp", 150, 0.5), time = vgm(1, "Exp", 5, 0.5), k = 5)
# 設定參數下限
pars.l <- c(sill.s = 0, range.s = 10, nugget.s = 0,sill.t = 0, range.t = 1,
nugget.t = 0, sill.st = 0, range.st = 10, nugget.st = 0, anis = 0, k = 0.01)
# 模型擬合
prodSumModel_Vgm <- fit.StVariogram(var, prodSumModel, method = "L-BFGS-B", lower = pars.l)
attr(prodSumModel_Vgm, "MSE")
extractPar(prodSumModel_Vgm)
# 1. 定義時空範圍
lon_range <- range(pivot_data$twd97lon) + c(-0.1, 0.1)  # 扩展范围
lat_range <- range(pivot_data$twd97lat) + c(-0.1, 0.1)
# time_range <- seq(as.Date("2024-01-01"), as.Date("2024-02-29"), by = "day")  # 时间序列
time_range <- seq(as.Date("2024-02-27"), as.Date("2024-02-29"), by = "day")  # 最后三天时间序列
# 2. 創建空間點
lon_seq <- seq(lon_range[1], lon_range[2], by = 0.05)
lat_seq <- seq(lat_range[1], lat_range[2], by = 0.05)
space_grid <- expand.grid(twd97lon = lon_seq, twd97lat = lat_seq)
space_grid
# 3. 創建時空點
# 組合時間空間點
time_grid <- rep(time_range, each = nrow(space_grid))  # 每个空间点对应所有时间
spatial_grid <- space_grid[rep(seq_len(nrow(space_grid)), times = length(time_range)), ]
# 4. 空grid
grid_data <- data.frame(
twd97lon = spatial_grid$twd97lon,
twd97lat = spatial_grid$twd97lat,
time = time_grid,
PM10 = NA  # 初始化要預測的網格
)
# 5. 創建 SpatialPoints 和 STFDF 對象
spatial_points <- SpatialPoints(space_grid, proj4string = CRS("+init=epsg:3826"))
grid_ST <- STFDF(
sp = spatial_points,
time = time_range,
data = data.frame(PM10 = rep(NA, length(time_range) * nrow(space_grid)))  # 修正行數
)
pr <- krigeST(PM10~1, data=STFDF_daily, modelList=prodSumModel_Vgm, newdata=grid_ST)
pr
stplot(pr)
predicted_values <- as.data.frame(pr)
slice_27 <- predicted_values%>%filter(time=='2024-02-27')
var
?fit.StVariogram
# 模型擬合
prodSumModel_Vgm <- fit.StVariogram(var, prodSumModel, lower = pars.l)
attr(prodSumModel_Vgm, "MSE")
extractPar(prodSumModel_Vgm)
# 1. 定義時空範圍
lon_range <- range(pivot_data$twd97lon) + c(-0.1, 0.1)  # 扩展范围
lat_range <- range(pivot_data$twd97lat) + c(-0.1, 0.1)
# time_range <- seq(as.Date("2024-01-01"), as.Date("2024-02-29"), by = "day")  # 时间序列
time_range <- seq(as.Date("2024-02-27"), as.Date("2024-02-29"), by = "day")  # 最后三天时间序列
# 2. 創建空間點
lon_seq <- seq(lon_range[1], lon_range[2], by = 0.05)
lat_seq <- seq(lat_range[1], lat_range[2], by = 0.05)
space_grid <- expand.grid(twd97lon = lon_seq, twd97lat = lat_seq)
stplot(pr)
predicted_values <- as.data.frame(pr)
slice_27 <- predicted_values%>%filter(time=='2024-02-27')
taiwan_map <- map("worldHires", "Taiwan", plot = FALSE, fill = TRUE)
world_clean <- world[!is.na(world$NAME), ]  # 去除 NAME 為 NA 的行
taiwan_map <- world_clean[world_clean$NAME == "Taiwan", ]
taiwan_map_sf <- st_as_sf(taiwan_map)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "#74dff2", size = 2, shape = 21, fill = "#74dff2") +
# 添加監測站名稱標籤
# geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
#           color = "#95edd7", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 Prediction Over Taiwan",
x = "Longitude",
y = "Latitude",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
ggplot() +
# PM10 預測數據 (slice_27)
geom_tile(data = slice_27, aes(x = twd97lon, y = twd97lat, fill = var1.pred)) +
# 疊加台灣地圖
geom_sf(data = taiwan_map_sf, color = "black", fill = NA, linetype = "solid") +
# 疊加監測站位置
geom_point(data = pivot_data, aes(x = twd97lon, y = twd97lat),
color = "#74dff2", size = 2, shape = 21, fill = "#74dff2") +
# 添加監測站名稱標籤
# geom_text(data = pivot_data, aes(x = twd97lon, y = twd97lat, label = station),
#           color = "#95edd7", size = 3, vjust = -1) +
# 色彩標度與主題
scale_fill_viridis_c() +
labs(
title = "PM10 pred",
x = "long",
y = "lat",
fill = "PM10"
) +
coord_sf(
xlim = range(slice_27$twd97lon),
ylim = range(slice_27$twd97lat)
)
pr
pr@time
pr@time == "2024-02-27"
slice_27
